<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Brevis Demo Testnet — Interactive Demo</title>
<!-- Chart.js for price chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg0:#07121b; --bg1:#082433; --card:#0c2736;
  --accent:#ffcc33; --accent2:#6c5ce7; --muted:#9fb0bd;
  --success:#16a34a; --danger:#ff6b6b;
  --glass: rgba(255,255,255,0.04);
  --glass-2: rgba(255,255,255,0.02);
}

/* Base */
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:0;color:#e9f7ff}
body{background:linear-gradient(180deg,var(--bg0),var(--bg1));min-height:100vh;padding:20px}

/* Topbar */
.topbar{
  display:flex;justify-content:space-between;align-items:center;padding:14px 18px;
  background:linear-gradient(90deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
  border-radius:14px;border:1px solid rgba(255,255,255,0.02);
  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
}
.brand{display:flex;gap:14px;align-items:center}
.logo{width:64px;height:64px;border-radius:14px;object-fit:cover;border:3px solid rgba(255,255,255,0.03)}
.title{font-weight:900;font-size:18px;letter-spacing:0.2px}
.small{font-size:13px;color:var(--muted)}

/* Layout */
.container{max-width:1200px;margin:20px auto;display:flex;gap:18px}
.left{flex:1;display:flex;flex-direction:column;gap:14px}
.right{width:420px;display:flex;flex-direction:column;gap:14px}

/* Cards */
.card{
  background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));
  padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.02);
  box-shadow: 0 10px 30px rgba(2,6,23,0.6);
}
h3{font-weight:900;margin:0 0 8px 0}

/* Buttons & inputs */
.btn{background:linear-gradient(90deg,var(--accent2),var(--accent));color:#061320;padding:10px 14px;border-radius:12px;border:none;cursor:pointer;font-weight:900;box-shadow:0 6px 18px rgba(108,92,231,0.12)}
.btn.ghost{background:transparent;border:1px solid var(--glass);color:var(--muted);font-weight:800}
.area{width:100%;padding:12px;border-radius:12px;border:1px solid var(--glass);background:transparent;color:inherit;font-weight:700}
.logbox{background:#021825;padding:12px;border-radius:10px;color:#bfe7ff;overflow:auto;height:240px;white-space:pre-wrap;font-size:13px}
.badge{font-size:12px;padding:6px 8px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--muted);font-weight:800}
.kv{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-top:6px;font-weight:800}

/* Modal (1:1) */
.modal-backdrop{position:fixed;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.55));display:flex;align-items:center;justify-content:center;z-index:999}
.modal{width:520px;height:520px;border-radius:20px;background:linear-gradient(135deg,#0b2f48,#08354a);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;border:2px solid rgba(255,255,255,0.03);box-shadow:0 30px 80px rgba(0,0,0,0.6)}
.modal img{width:160px;height:160px;border-radius:18px;border:4px solid rgba(255,255,255,0.04);object-fit:cover}
.modal h2{font-size:22px;font-weight:900}
.modal p{color:var(--muted);text-align:center;margin:0 18px;font-weight:700}

/* Quiz */
.quiz-option{display:block;padding:12px;border-radius:12px;border:1px solid var(--glass);margin-top:10px;cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));font-weight:800}
.quiz-option:hover{transform:translateY(-4px);transition:0.12s;border-color:rgba(255,255,255,0.06)}
.quiz-option.selected{outline:3px solid rgba(108,92,231,0.18);box-shadow:0 8px 20px rgba(108,92,231,0.12)}
.quiz-option.correct{background:linear-gradient(90deg, rgba(22,163,74,0.12), rgba(22,163,74,0.06));border:2px solid rgba(22,163,74,0.25);color:var(--success);font-weight:900}
.quiz-option.wrong{background:linear-gradient(90deg, rgba(255,107,107,0.08), rgba(255,107,107,0.03));border:2px solid rgba(255,107,107,0.2);color:var(--danger);font-weight:900}

/* Stepper */
.step{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);font-weight:900}
.step.active{background:linear-gradient(90deg,var(--accent2),var(--accent));color:#061320;box-shadow:0 8px 20px rgba(108,92,231,0.12)}

/* Other small tweaks */
.small-muted{color:var(--muted);font-size:13px}
.leaderboard{display:flex;flex-direction:column;gap:8px}
.row-space{display:flex;justify-content:space-between;align-items:center}
@media(max-width:900px){ .container{flex-direction:column} .right{width:100%} .modal{width:92vw;height:92vw} }
</style>
</head>
<body>

<!-- Welcome (1:1) -->
<div id="welcome" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal" role="document" aria-labelledby="welcomeTitle">
    <img id="welcomeLogo" src="logo.png" alt="logo"/>
    <h2 id="welcomeTitle">Welcome to the Brevis Demo Testnet</h2>
    <p class="small-muted">Interactive sandbox: answer quick questions to claim faucet, try swap with gas simulation, earn XP & compete on the leaderboard. This is a learning demo — no real funds.</p>
    <div style="display:flex;gap:12px">
      <button id="startBtn" class="btn">Start Demo</button>
      <button id="skipBtn" class="btn ghost">Skip</button>
    </div>
    <div class="small-muted" style="margin-top:6px">Project: <a href="https://blog.brevis.network/" target="_blank" style="color:#9ae6b4">Brevis Blog</a> • Created by <b style="font-weight:900">@AmitKum955</b></div>
  </div>
</div>

<!-- Topbar -->
<div class="topbar">
  <div class="brand">
    <img src="logo.png" alt="logo" class="logo"/>
    <div>
      <div class="title">Brevis Demo Testnet (Demo)</div>
      <div class="small">Learn how a Brevis-integrated app might look and behave</div>
    </div>
  </div>

  <div style="display:flex;gap:12px;align-items:center">
    <a href="https://discord.com/channels/1287736665103798433/1319430298265456803" target="_blank" class="small" style="text-decoration:none;color:var(--muted)">Discord</a>
    <a href="https://x.com/zama" target="_blank" class="small" style="text-decoration:none;color:var(--muted)">X</a>
    <a href="https://docs.zama.org/protocol" target="_blank" class="small" style="text-decoration:none;color:var(--muted)">Docs</a>
    <div class="badge" id="xpBadge">XP: 0</div>
    <button id="connectBtn" class="btn">Connect Wallet</button>
  </div>
</div>

<main class="container" aria-live="polite">

  <section class="left">

    <!-- Wallet & Faucet + quiz -->
    <div class="card" id="walletCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Wallet & Faucet</h3>
        <div class="small-muted">Chain: <b>brevis-demo</b></div>
      </div>

      <div class="kv"><div class="small-muted">Address</div><div id="walletAddr">Not connected</div></div>
      <div class="kv"><div class="small-muted">Balances</div><div id="balances">tBREV: 0 • tUSDC: 0</div></div>

      <div style="margin-top:10px" class="small-muted">Name / Email (required for faucet):</div>
      <input id="claimId" class="area" placeholder="enter name or email" />

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
        <button id="claimFaucetBtn" class="btn">Claim Faucet (Answer 6 Questions)</button>
        <button id="viewQuizBtn" class="btn ghost">Open Quiz</button>
      </div>

      <div style="margin-top:10px" class="small-muted">Faucet rule: one claim per wallet OR one claim per name/email (stored locally). To receive faucet you must correctly answer the 6 quick questions.</div>
    </div>

    <!-- Quiz card (hidden until opened) -->
    <div class="card" id="quizCard" style="display:none">
      <h3>Quick Quiz — answer correctly to claim faucet</h3>
      <div id="quizArea" style="margin-top:10px"></div>
      <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
        <button id="quizPrev" class="btn ghost">Previous</button>
        <button id="quizNext" class="btn">Next</button>
        <div style="margin-left:auto" class="small-muted">Progress: <span id="quizProgress">0/6</span></div>
      </div>
      <div style="margin-top:8px" class="small-muted">You need all 6 correct to unlock faucet. Questions show one-by-one. Correct answers will be highlighted green, wrong red after finishing.</div>
    </div>

    <!-- Swap -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Swap (Demo)</h3>
        <div class="small-muted">Rate: <span id="rateDisplay">1 tBREV = 1.0 tUSDC</span></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
        <select id="fromToken" class="area" style="width:140px">
          <option value="BREV">tBREV</option>
          <option value="USDC">tUSDC</option>
        </select>

        <select id="toToken" class="area" style="width:140px">
          <option value="USDC">tUSDC</option>
          <option value="BREV">tBREV</option>
        </select>

        <input id="amount" type="number" class="area" placeholder="Amount" style="width:120px" />
        <button id="swapBtn" class="btn">Swap</button>
      </div>

      <div style="margin-top:10px" class="small-muted">
        <div>Swaps done (this wallet): <b id="swapCount">0</b></div>
        <label style="margin-top:6px"><input type="checkbox" id="shareApr" /> Share a result on X after swap</label>
      </div>
    </div>

    <!-- Quests / XP -->
    <div class="card">
      <h3>Quests & XP</h3>
      <div class="small-muted">Earn XP and appear on leaderboard</div>
      <ul style="margin-top:10px">
        <li>Connect Wallet: <b>+10 XP</b></li>
        <li>Claim Faucet: <b>+20 XP</b></li>
        <li>First Swap: <b>+50 XP</b></li>
        <li>Total 5 Swaps: <b>+100 XP</b></li>
      </ul>
      <div style="margin-top:8px" class="small-muted">Your XP: <b id="xpTotal">0</b></div>
    </div>

  </section>

  <aside class="right">

    <!-- Nodes -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>MPC Nodes</h3>
        <button id="refreshNodes" class="btn ghost">Refresh</button>
      </div>
      <div id="nodes" class="small-muted" style="margin-top:8px">Loading...</div>
    </div>

    <!-- Price Chart -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Token Price</h3>
        <div class="small-muted">Auto-updating</div>
      </div>
      <canvas id="priceChart" height="120" style="margin-top:8px"></canvas>
    </div>

    <!-- Logs -->
    <div class="card">
      <h3>Transactions / Logs</h3>
      <div id="lastTx" class="small-muted">Last TX: -</div>
      <div id="logs" class="logbox" style="margin-top:8px">No logs yet</div>
      <div style="margin-top:8px" class="row">
        <button id="clearBtn" class="btn ghost">Clear Logs</button>
        <button id="resetBtn" class="btn ghost">Reset Demo</button>
      </div>
    </div>

    <!-- Leaderboard -->
    <div class="card">
      <h3>Leaderboard</h3>
      <div id="leaderboard" class="leaderboard" style="margin-top:8px">No entries yet</div>
    </div>

  </aside>

</main>

<script>
/* ---------- Demo single-file JS ---------- */

/* Elements */
const startBtn = document.getElementById('startBtn');
const skipBtn = document.getElementById('skipBtn');
const welcome = document.getElementById('welcome');

const connectBtn = document.getElementById('connectBtn');
const walletAddrEl = document.getElementById('walletAddr');
const balancesEl = document.getElementById('balances');
const faucetBtn = document.getElementById('claimFaucetBtn');
const viewQuizBtn = document.getElementById('viewQuizBtn');

const quizCard = document.getElementById('quizCard');
const quizArea = document.getElementById('quizArea');
const quizPrev = document.getElementById('quizPrev');
const quizNext = document.getElementById('quizNext');
const quizProgress = document.getElementById('quizProgress');

const claimId = document.getElementById('claimId');
const swapBtn = document.getElementById('swapBtn');
const fromToken = document.getElementById('fromToken');
const toToken = document.getElementById('toToken');
const amountInput = document.getElementById('amount');
const swapCountEl = document.getElementById('swapCount');
const shareAprCheckbox = document.getElementById('shareApr');

const logsEl = document.getElementById('logs');
const lastTxEl = document.getElementById('lastTx');
const clearBtn = document.getElementById('clearBtn');
const resetBtn = document.getElementById('resetBtn');

const xpBadge = document.getElementById('xpBadge');
const xpTotalEl = document.getElementById('xpTotal');
const leaderboardEl = document.getElementById('leaderboard');
const rateDisplay = document.getElementById('rateDisplay');
const refreshNodes = document.getElementById('refreshNodes');
const nodesEl = document.getElementById('nodes');

/* Chart */
const priceChartCtx = document.getElementById('priceChart').getContext('2d');

/* State */
let wallet = null;
let balances = { BREV:0, USDC:0 };
let logs = [];
let xp = 0;
let swapsDone = 0;
let rate = 1.0;
let priceData = { labels:[], data:[] };

/* Quiz: 6 questions (English, generic Brevis-style) */
const quizQuestions = [
  {
    q: "What is the primary goal of Brevis network?",
    options: [
      "Offload heavy computations and verify them with proofs",
      "Only provide a wallet service",
      "Act as a centralized exchange",
      "Replace the internet"
    ],
    answer: 0
  },
  {
    q: "Brevis uses which technique to make on-chain verification efficient?",
    options: [
      "Proof-of-Work mining",
      "Zero-knowledge proofs / verifiable proofs",
      "Centralized verification",
      "Proof-of-Stake only"
    ],
    answer: 1
  },
  {
    q: "A demo testnet should be used primarily for:",
    options: [
      "Testing and learning without real funds",
      "Stealing funds",
      "Producing production transactions",
      "Sending spam"
    ],
    answer: 0
  },
  {
    q: "What is a faucet in testnet context?",
    options: [
      "A tool to claim test tokens for testing",
      "A real money payment method",
      "A governance proposal",
      "A validator"
    ],
    answer: 0
  },
  {
    q: "Why simulate gas & fees in demo?",
    options: [
      "To provide a realistic dApp feel and learning",
      "To charge real fees",
      "To slow down users",
      "To hide features"
    ],
    answer: 0
  },
  {
    q: "What's a simple reason to use a mock testnet UI?",
    options: [
      "To practice integration and UX before live deployment",
      "To launch tokens with value",
      "To replace documentation",
      "To avoid coding"
    ],
    answer: 0
  }
];

/* Quiz runtime variables */
let quizIndex = 0;
let quizSelections = new Array(quizQuestions.length).fill(null);
let quizCorrectCount = 0;

/* Utilities */
function pushLog(obj){
  obj.time = new Date().toLocaleTimeString();
  logs.unshift(obj);
  if(logs.length > 200) logs.pop();
  renderLogs();
}
function renderLogs(){
  logsEl.textContent = logs.map(l=>JSON.stringify(l,null,2)).join('\\n\\n');
  const confirmed = logs.find(l=>l.type === 'tx_confirmed');
  lastTxEl.textContent = confirmed ? ('Last TX: ' + confirmed.tx) : 'Last TX: -';
}
function updateBalancesUI(){ balancesEl.textContent = `tBREV: ${balances.BREV} • tUSDC: ${balances.USDC}`; }
function updateXPUI(){ xpBadge.textContent = 'XP: ' + xp; xpTotalEl.textContent = xp; }

/* Leaderboard */
function updateLeaderboard(){
  const data = [];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.startsWith('demo_xp_')){
      data.push({ wallet:k.replace('demo_xp_',''), xp: parseInt(localStorage.getItem(k) || '0',10) });
    }
  }
  data.sort((a,b)=>b.xp-a.xp);
  if(!data.length) { leaderboardEl.innerHTML = '<div class="small-muted">No entries yet</div>'; return; }
  leaderboardEl.innerHTML = data.slice(0,10).map((d,i)=>`<div style="display:flex;justify-content:space-between"><div>#${i+1} ${d.wallet}</div><div>${d.xp} XP</div></div>`).join('');
}

/* Wallet connect (fake) */
connectBtn.addEventListener('click', ()=>{
  if(!wallet){
    wallet = '0x' + Math.random().toString(16).substr(2,10);
    connectBtn.textContent = 'Disconnect';
    walletAddrEl.textContent = wallet;
    pushLog({ type:'wallet', event:'connected', address: wallet });
    // load balances / xp
    const b = localStorage.getItem('demo_balances_' + wallet);
    if(b) balances = JSON.parse(b);
    swapsDone = parseInt(localStorage.getItem('demo_swap_count_' + wallet) || '0',10);
    swapCountEl.textContent = swapsDone;
    xp = parseInt(localStorage.getItem('demo_xp_' + wallet) || '0',10);
    updateBalancesUI(); updateXPUI(); updateLeaderboard();
    grantXP(10,'Connect Wallet');
  } else {
    pushLog({ type:'wallet', event:'disconnected', address: wallet });
    wallet = null;
    walletAddrEl.textContent = 'Not connected';
    connectBtn.textContent = 'Connect Wallet';
    balances = { BREV:0, USDC:0 };
    xp = 0; swapsDone = 0;
    updateBalancesUI(); updateXPUI(); updateLeaderboard();
  }
});

/* Faucet logic: requires all 6 correct OR previously claimed */
function claimKeyWallet(addr){ return 'demo_claim_wallet_' + addr; }
function claimKeyId(id){ return 'demo_claim_id_' + id; }
function canClaim(addr,id){
  if(addr && localStorage.getItem(claimKeyWallet(addr))) return false;
  if(id && localStorage.getItem(claimKeyId(id))) return false;
  return true;
}
function markClaim(addr,id){
  if(addr) localStorage.setItem(claimKeyWallet(addr), JSON.stringify({time:new Date().toISOString()}));
  if(id) localStorage.setItem(claimKeyId(id), JSON.stringify({time:new Date().toISOString()}));
}

faucetBtn.addEventListener('click', ()=>{
  // open quiz if not completed
  if(quizCorrectCount === quizQuestions.length){
    // already passed - try to give faucet (but check claims)
    giveFaucet();
    return;
  }
  // open quiz
  showQuiz();
});

function giveFaucet(){
  const id = (claimId.value||'').trim();
  if(!wallet && !id){ alert('Connect wallet or enter a name/email to claim faucet'); return; }
  if(!canClaim(wallet, id)){ alert('This wallet or id already claimed faucet'); return; }
  // require quiz success
  if(quizCorrectCount !== quizQuestions.length){
    alert('You must answer all quiz questions correctly to claim faucet.');
    showQuiz();
    return;
  }
  // award tokens
  balances.BREV = Math.round((balances.BREV + 200) * 10000)/10000; // give more (200)
  balances.USDC = Math.round((balances.USDC + 50) * 10000)/10000;
  persistBalances();
  updateBalancesUI();
  pushLog({ type:'faucet', token:'tBREV & tUSDC', by: wallet || id, amount: '200 / 50' });
  markClaim(wallet, id);
  grantXP(20,'Claim Faucet');
  alert('Faucet credited to your demo wallet (tBREV + tUSDC). Good job!');
}

/* Persist balances */
function persistBalances(){ if(wallet) localStorage.setItem('demo_balances_' + wallet, JSON.stringify(balances)); }

/* Quiz UI */
function showQuiz(){
  quizCard.style.display = 'block';
  quizIndex = 0;
  quizSelections = new Array(quizQuestions.length).fill(null);
  quizCorrectCount = 0;
  renderQuiz();
}
function hideQuiz(){ quizCard.style.display = 'none'; }
viewQuizBtn.addEventListener('click', showQuiz);

/* render quiz question */
function renderQuiz(){
  const q = quizQuestions[quizIndex];
  quizArea.innerHTML = `
    <div style="font-weight:900;color:var(--accent2)">Question ${quizIndex+1} of ${quizQuestions.length}</div>
    <div style="margin-top:8px;font-size:15px;font-weight:800">${q.q}</div>
    <div id="options" style="margin-top:10px"></div>
  `;
  const opts = document.getElementById('options');
  q.options.forEach((opt, idx)=>{
    const btn = document.createElement('div');
    btn.className = 'quiz-option' + (quizSelections[quizIndex] === idx ? ' selected' : '');
    btn.textContent = opt;
    btn.onclick = ()=> {
      // select
      quizSelections[quizIndex] = idx;
      // update selection visuals
      Array.from(opts.children).forEach((c,i)=> c.className = 'quiz-option' + (i===idx ? ' selected' : '') );
    };
    opts.appendChild(btn);
  });
  quizProgress.textContent = `${quizIndex+1}/${quizQuestions.length}`;
  quizPrev.disabled = quizIndex === 0;
  quizNext.textContent = quizIndex === quizQuestions.length - 1 ? 'Finish' : 'Next';
}

/* Prev / Next handlers */
quizPrev.addEventListener('click', ()=>{
  if(quizIndex > 0){ quizIndex--; renderQuiz(); }
});
quizNext.addEventListener('click', ()=>{
  // require selection
  if(quizSelections[quizIndex] === null){ alert('Please select an option to proceed'); return; }
  // If last, evaluate
  if(quizIndex === quizQuestions.length - 1){
    // evaluate score and show answer coloring
    quizCorrectCount = 0;
    // color each question's option elements (we'll display review)
    // Instead of reusing same DOM, build a review view
    const review = document.createElement('div');
    review.innerHTML = '<div style="font-weight:900;margin-bottom:8px">Review answers</div>';
    quizQuestions.forEach((qq,i)=>{
      const block = document.createElement('div');
      block.style.marginTop = '10px';
      const qtitle = document.createElement('div');
      qtitle.style.fontWeight = '800';
      qtitle.textContent = `Q${i+1}. ${qq.q}`;
      block.appendChild(qtitle);
      qq.options.forEach((opt,j)=>{
        const optEl = document.createElement('div');
        optEl.className = 'quiz-option';
        optEl.style.marginTop = '6px';
        optEl.textContent = opt;
        // mark correct/wrong
        if(j === qq.answer){
          optEl.classList.add('correct');
        }
        if(quizSelections[i] === j && quizSelections[i] !== qq.answer){
          optEl.classList.add('wrong');
        }
        block.appendChild(optEl);
      });
      review.appendChild(block);
    });
    quizArea.innerHTML = '';
    quizArea.appendChild(review);

    // compute correct count
    for(let i=0;i<quizQuestions.length;i++){
      if(quizSelections[i] === quizQuestions[i].answer) quizCorrectCount++;
    }

    if(quizCorrectCount === quizQuestions.length){
      alert('Excellent! You answered all questions correctly. Faucet is unlocked.');
      hideQuiz();
      giveFaucet();
    } else {
      alert(`You answered ${quizCorrectCount} / ${quizQuestions.length} correctly. You need all correct to automatically receive faucet. You can review answers (green = correct) and try again.`);
      // keep review visible so user sees correct/wrong coloring
      quizPrev.disabled = false;
      quizNext.textContent = 'Retry';
      quizNext.onclick = ()=> {
        // reset to initial state for retry
        quizIndex = 0;
        quizSelections = new Array(quizQuestions.length).fill(null);
        quizCorrectCount = 0;
        renderQuiz();
        // restore original next handler after resetting
        quizNext.onclick = defaultQuizNextHandler;
      };
    }
    return;
  }
  quizIndex++;
  renderQuiz();
});

/* Save default next handler to restore later when needed */
const defaultQuizNextHandler = quizNext.onclick;

/* XP awarding */
function grantXP(amount, reason){
  xp += amount;
  updateXPUI();
  if(wallet) localStorage.setItem('demo_xp_' + wallet, String(xp));
  updateLeaderboard();
  pushLog({ type:'xp', amount, reason });
}

/* Swap modal + execution (approve -> processing -> confirmed) */
function createTxHash(){ return '0x' + Math.random().toString(16).substr(2,12); }

function openSwapModalAndExecute(from, to, amount){
  return new Promise((resolve, reject) => {
    const modal = document.createElement('div');
    modal.style.position='fixed'; modal.style.inset='0'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center';
    modal.style.background='rgba(0,0,0,0.6)'; modal.style.zIndex=9999;
    modal.innerHTML = `
      <div style="background:#071827;padding:18px;border-radius:12px;min-width:380px;color:#eaf6ff">
        <div style="font-weight:800;margin-bottom:8px">Swap: ${amount} ${from} → ${to}</div>
        <div id="stepper" style="display:flex;gap:8px;margin-bottom:10px">
          <div class="step active">1 Approve</div>
          <div class="step">2 Processing</div>
          <div class="step">3 Confirmed</div>
        </div>
        <div id="modalBody" style="min-height:80px" class="small-muted">Waiting for approval...</div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="cancelSwap" style="padding:8px 10px;border-radius:8px;border:none;background:transparent;color:var(--muted);cursor:pointer">Cancel</button>
          <button id="nextSwap" style="padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent2),var(--accent));color:#061320;cursor:pointer">Approve</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    const stepEls = modal.querySelectorAll('.step');
    const bodyEl = modal.querySelector('#modalBody');
    const cancelBtn = modal.querySelector('#cancelSwap');
    const nextBtn = modal.querySelector('#nextSwap');
    let step = 0;
    const tx = createTxHash();

    function setStep(n){
      step = n;
      stepEls.forEach((s,i)=> s.className = 'step' + (i===n ? ' active' : ''));
    }

    cancelBtn.onclick = ()=>{ document.body.removeChild(modal); pushLog({type:'swap', event:'cancelled'}); reject('cancelled'); };

    nextBtn.onclick = () => {
      if(step === 0){
        bodyEl.innerHTML = 'Approving token (simulated)...';
        nextBtn.disabled = true;
        setTimeout(()=> {
          setStep(1);
          bodyEl.innerHTML = 'Processing swap...';
          nextBtn.textContent = 'Processing';
          // simulate processing delay
          setTimeout(()=> {
            setStep(2);
            // gas simulation
            const gasUsed = Math.floor(Math.random()*(90000-45000))+45000;
            const gasPrice = (Math.random()*(3-1)+1).toFixed(2);
            const gasCost = (gasUsed * gasPrice * 1e-9).toFixed(6); // demo unit
            const feePct = 0.005;
            const received = (from === 'BREV') ? (amount * rate * (1 - feePct)) : ((amount / rate) * (1 - feePct));
            const receivedRounded = Math.round(received * 10000)/10000;
            bodyEl.innerHTML = `
              <div style="font-weight:900;color:var(--accent2)">Swap confirmed ✅</div>
              <div style="margin-top:8px">Tx: <b>${tx}</b></div>
              <div style="margin-top:6px">Gas used: <b>${gasUsed}</b> • Gas price: <b>${gasPrice} gwei</b></div>
              <div style="margin-top:6px">Estimated gas (demo): <b>${gasCost}</b></div>
              <div style="margin-top:6px">Received: <b>${receivedRounded} ${to}</b></div>
            `;
            // update balances
            if(from === 'BREV'){ balances.BREV = Math.round((balances.BREV - amount) * 10000)/10000; balances.USDC = Math.round((balances.USDC + receivedRounded) * 10000)/10000; }
            else { balances.USDC = Math.round((balances.USDC - amount) * 10000)/10000; balances.BREV = Math.round((balances.BREV + receivedRounded) * 10000)/10000; }
            persistBalances(); updateBalancesUI();
            const txObj = { type:'tx_confirmed', tx, from, to, amount, received:receivedRounded, gasUsed, gasPrice, gasCost };
            pushLog(txObj);
            swapsDone = parseInt(localStorage.getItem('demo_swap_count_' + wallet) || '0',10) + 1;
            localStorage.setItem('demo_swap_count_' + wallet, String(swapsDone));
            swapCountEl.textContent = swapsDone;
            if(swapsDone === 1) grantXP(50,'First Swap');
            if(swapsDone === 5) grantXP(100,'5 Swaps Milestone');
            // optional share
            if(shareAprCheckbox.checked){
              const projectLink = 'https://blog.brevis.network/';
              const text = encodeURIComponent(`Tried the Brevis Demo Testnet — swapped ${amount} ${from} → ${receivedRounded} ${to}. Learn more: ${projectLink} Created by @AmitKum955`);
              window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
            }
            nextBtn.textContent = 'Close';
            nextBtn.disabled = false;
            nextBtn.onclick = ()=>{ document.body.removeChild(modal); resolve(txObj); };
          }, 1400);
        }, 900);
      }
    };
  });
}

/* Swap button */
swapBtn.addEventListener('click', async ()=>{
  if(!wallet){ alert('Connect wallet first'); return; }
  const from = fromToken.value;
  const to = toToken.value;
  const amount = parseFloat(amountInput.value);
  if(from === to){ alert('Select two different tokens'); return; }
  if(!amount || amount <= 0){ alert('Enter a valid amount'); return; }
  const inToken = from === 'BREV' ? 'BREV' : 'USDC';
  if(balances[inToken] < amount){ alert('Insufficient balance. Please use faucet.'); return; }
  try {
    pushLog({ type:'swap_submitted', from, to, amount, status:'pending' });
    await openSwapModalAndExecute(from, to, amount);
    updateBalancesUI(); renderLogs();
  } catch(e){
    pushLog({ type:'swap_cancelled' });
  }
});

/* Nodes */
function renderNodes(){
  const arr = [];
  for(let i=1;i<=5;i++){ arr.push({ id:i, status: Math.random() > 0.08 ? 'ONLINE' : 'OFFLINE' }); }
  nodesEl.innerHTML = arr.map(n=>`Node ${n.id}: <span style="color:${n.status==='ONLINE'?'#6ee7b7':'#ff6b6b'}">${n.status}</span>`).join('<br>');
  pushLog({ type:'nodes', event:'refreshed', states: arr.map(x=>x.status) });
}
refreshNodes.addEventListener('click', renderNodes);

/* Chart (random walk) */
let chart;
function initChart(){
  const now = Date.now();
  priceData.labels = [];
  priceData.data = [];
  let p = rate;
  for(let i=20;i>0;i--){
    p = Math.max(0.1, p + (Math.random()-0.5)*0.03);
    priceData.labels.push(new Date(now - i*1000).toLocaleTimeString());
    priceData.data.push(Math.round(p*10000)/10000);
  }
  chart = new Chart(priceChartCtx, {
    type:'line',
    data:{ labels: priceData.labels, datasets:[{ label:'tBREV price (vs tUSDC)', data: priceData.data, fill:true, tension:0.25, backgroundColor:'rgba(108,92,231,0.08)', borderColor:'#6c5ce7' }] },
    options:{ animation:false, scales:{ y:{ beginAtZero:false } } }
  });
  setInterval(()=> {
    const last = priceData.data[priceData.data.length-1];
    const next = Math.max(0.05, Math.round((last + (Math.random()-0.5)*0.02)*10000)/10000);
    priceData.labels.push(new Date().toLocaleTimeString());
    priceData.data.push(next);
    if(priceData.labels.length>30){ priceData.labels.shift(); priceData.data.shift(); }
    chart.data.labels = priceData.labels; chart.data.datasets[0].data = priceData.data; chart.update();
    rate = next; rateDisplay.textContent = `1 tBREV = ${Math.round(rate*100)/100} tUSDC`;
  }, 2500);
}

/* Local utilities */
clearBtn.addEventListener('click', ()=>{ logs = []; renderLogs(); pushLog({ type:'logs', event:'cleared' }); });
resetBtn.addEventListener('click', ()=>{ if(confirm('Reset demo local data? (clears localStorage)')){ localStorage.clear(); location.reload(); } });

/* Welcome controls */
startBtn.addEventListener('click', ()=>{ welcome.style.display = 'none'; pushLog({ type:'demo', event:'started' }); });
skipBtn.addEventListener('click', ()=>{ welcome.style.display = 'none'; pushLog({ type:'demo', event:'skipped' }); });

/* Init */
renderNodes();
initChart();
renderLogs();
updateBalancesUI();
updateXPUI();
updateLeaderboard();

/* Keyboard W toggles welcome */
document.addEventListener('keydown', (e)=>{ if(e.key && e.key.toLowerCase()==='w'){ welcome.style.display = welcome.style.display === 'none' ? 'flex' : 'none'; } });

/* Expose quizQuestions for debugging if needed */
window.quizQuestions = quizQuestions;
</script>
</body>
</html>
